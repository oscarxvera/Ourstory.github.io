<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CheeseMap</title>

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    :root{
      --bg:#0b1220;
      --border: rgba(255,255,255,.10);
      --text:#eaf1ff;
      --muted:#9bb0d0;
      --accent:#6aa7ff;
      --danger:#ff6a7a;
      --shadow: 0 14px 40px rgba(0,0,0,.38);
    }
    *{box-sizing:border-box}
    html, body {height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;
    }
    #map{position:fixed; inset:0}

    .maplibregl-ctrl-attrib{
      background: rgba(15,27,51,.75) !important;
      border: 1px solid rgba(255,255,255,.10) !important;
      border-radius: 12px !important;
      backdrop-filter: blur(10px);
    }

    .topbarWrap{
      position:fixed;
      top:12px; left:12px; right:12px;
      z-index:10;
      pointer-events:none;
    }
    .topbar{
      pointer-events:auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      background: rgba(11,18,32,.58);
      border:1px solid var(--border);
      border-radius: 22px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      transition: transform .22s ease, opacity .22s ease;
    }
    .topbar.collapsed{
      transform: translateY(-120%);
      opacity: 0;
      pointer-events:none;
    }

    .brand{
      display:flex; gap:10px; align-items:center;
      font-weight:900;
      letter-spacing:.2px;
      padding-left:4px;
      white-space:nowrap;
      min-width: 140px;
    }
    .brand .dot{
      width:10px; height:10px; border-radius:99px;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(106,167,255,.55);
      flex:0 0 auto;
    }
    .brand .sub{
      color: var(--muted);
      font-weight:700;
      font-size: 12px;
      margin-left:4px;
    }

    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      position:relative;
      width: 100%;
    }

    .searchWrap{
      position:relative;
      display:flex;
      align-items:center;
      gap:8px;
      min-width: min(560px, 62vw);
      max-width: min(820px, 72vw);
      flex: 1 1 auto;
    }
    .searchGroup{
      position:relative;
      width:100%;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .search{
      width:100%;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:11px 42px 11px 40px;
      color: var(--text);
      outline:none;
      transition: background .15s ease, border-color .15s ease;
    }
    .search:focus{
      background: rgba(255,255,255,.13);
      border-color: rgba(106,167,255,.35);
    }
    .searchIcon{
      position:absolute;
      left:14px;
      top:50%;
      transform: translateY(-50%);
      opacity:.85;
      font-size: 14px;
      pointer-events:none;
    }
    .clearBtn{
      position:absolute;
      right:10px;
      top:50%;
      transform: translateY(-50%);
      border:none;
      background: rgba(255,255,255,.10);
      color: var(--text);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding:6px 9px;
      cursor:pointer;
      display:none;
    }
    .clearBtn.show{display:block}

    .select{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:10px 10px;
      color: var(--text);
      outline:none;
      cursor:pointer;
      white-space:nowrap;
    }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: var(--accent);
      color:#071126;
      font-weight:900;
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn.ghost{
      background: rgba(255,255,255,.10);
      color: var(--text);
      font-weight:800;
    }
    .btn:active{transform: translateY(1px)}

    .togglePill{
      pointer-events:auto;
      position:fixed;
      right:14px;
      top:92px;
      z-index:11;
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(11,18,32,.62);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      cursor:pointer;
      user-select:none;
    }
    .togglePill .k{
      width:26px;height:26px;border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .togglePill span{
      font-weight:850;
      font-size: 12px;
      color: var(--text);
    }

    .dropdown{
      position:absolute;
      top:56px;
      right:0;
      width:min(620px, 92vw);
      background: rgba(15,27,51,.96);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index:11;
      backdrop-filter: blur(12px);
    }
    .dropdown.open{display:block}

    .dd-head{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .dd-head .muted{color:var(--muted); font-size:12px}

    .dd-item{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start;
    }
    .dd-item:hover{background: rgba(255,255,255,.06)}
    .dd-ico{
      width:30px; height:30px;
      border-radius: 12px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      margin-top:1px;
    }
    .dd-title{font-weight:900; font-size:13px; line-height:1.2}
    .dd-sub{color: var(--muted); font-size:12px; margin-top:2px}

    .searchCard{
      position:fixed;
      left:12px;
      right:12px;
      bottom:12px;
      z-index:10;
      display:none;
      background: rgba(15,27,51,.92);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding:12px;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .searchCard.open{display:flex}
    .searchCard .txt{display:flex; flex-direction:column; gap:2px; overflow:hidden}
    .searchCard .t1{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .searchCard .t2{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .searchCard .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    .egg{
      position:fixed; inset:0;
      z-index:40;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(8px);
    }
    .egg.open{display:flex}
    .egg-card{
      width:min(920px, 96vw);
      background: rgba(15,27,51,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .egg-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .egg-title{
      font-weight:900;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .egg-title .dot{
      width:10px;height:10px;border-radius:99px;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(106,167,255,.55);
    }
    .egg-body{
      padding:12px;
      display:flex;
      justify-content:center;
      background: rgba(0,0,0,.18);
    }

    @media (max-width: 720px){
      .dropdown{right:auto; left:0; width: calc(100vw - 24px);}
      .searchWrap{min-width: 100%; max-width: 100%;}
      .searchCard{flex-direction:column; align-items:stretch}
      .searchCard .actions{justify-content:stretch}
      .searchCard .actions .btn{flex:1}
      .brand{min-width:auto}
      .topbar{border-radius: 18px}
      .togglePill{top:124px;}
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="topbarWrap">
    <div class="topbar" id="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>CheeseMap</span>
        <span class="sub">CA</span>
      </div>

      <div class="controls">
        <select id="styleSel" class="select" title="Map style">
          <option value="streets">Streets</option>
          <option value="dark">Dark</option>
          <option value="satellite">Satellite</option>
          <option value="hybrid">Satellite + Labels</option>
        </select>

        <div class="searchWrap">
          <div class="searchGroup">
            <span class="searchIcon">üîé</span>
            <input id="search" class="search" type="text" placeholder="Search any full address (home, business, city)..." autocomplete="off" />
            <button id="clearSearch" class="clearBtn" title="Clear">‚úï</button>
          </div>

          <button id="btnSearch" class="btn ghost" title="Search">Search</button>
          <div id="dropdown" class="dropdown"></div>
        </div>

        <button id="btnLocate" class="btn ghost">Locate</button>
        <button id="btnHelp" class="btn ghost">Help</button>
      </div>
    </div>
  </div>

  <div class="togglePill" id="togglePill" title="Show/Hide toolbar">
    <div class="k" id="toggleIcon">‚åÉ</div>
    <span id="toggleText">Hide</span>
  </div>

  <div class="searchCard" id="searchCard">
    <div class="txt">
      <div class="t1" id="scTitle">Result</div>
      <div class="t2" id="scSub">Address</div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnClearResult">Clear</button>
    </div>
  </div>

  <!-- Easter Egg Overlay -->
  <div class="egg" id="egg">
    <div class="egg-card">
      <div class="egg-head">
        <div class="egg-title"><span class="dot"></span> IDEN</div>
        <button class="btn ghost" id="btnEggClose">‚úï</button>
      </div>

      <!-- ‚úÖ FIXED: iden.png (cache-busted) + fallback message if anything breaks -->
      <div class="egg-body">
        <img
          id="eggImg"
          src="iden.png?v=2"
          alt="IDEN"
          style="width:100%;height:auto;max-height:78vh;object-fit:contain;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);"
          onerror="this.style.display='none';document.getElementById('eggImgErr').style.display='block';"
        />
        <div id="eggImgErr" style="display:none;color:rgba(255,255,255,.7);padding:16px;text-align:center;">
          Image failed to load. Confirm <b>iden.png</b> is in the repo root (same folder as index.html).
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <script>
    // ‚úÖ NEW KEY
    const MAPTILER_KEY = "eh8GLc1kXlfzsyg5cLYi";

    const STYLES = {
      streets:   `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`,
      dark:      `https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY}`,
      satellite: `https://api.maptiler.com/maps/satellite/style.json?key=${MAPTILER_KEY}`,
      hybrid:    `https://api.maptiler.com/maps/hybrid/style.json?key=${MAPTILER_KEY}`
    };

    const CA_BOUNDS = [
      [-124.482003, 32.528832],
      [-114.131211, 42.009518]
    ];

    const $ = (id) => document.getElementById(id);
    const debounce = (fn, ms=250) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function isInCA(lng, lat){
      return (
        lng >= CA_BOUNDS[0][0] && lng <= CA_BOUNDS[1][0] &&
        lat >= CA_BOUNDS[0][1] && lat <= CA_BOUNDS[1][1]
      );
    }

    let map;
    let searchMarker = null;
    let selectedSearch = null;

    function setSearchMarker(lng, lat){
      if (searchMarker) searchMarker.remove();
      searchMarker = new maplibregl.Marker({ color: "#ffffff" })
        .setLngLat([lng, lat])
        .addTo(map);
    }

    function initMap(){
      map = new maplibregl.Map({
        container: "map",
        style: STYLES.streets,
        bounds: CA_BOUNDS,
        fitBoundsOptions: { padding: 40, maxZoom: 12 },
        pitch: 45,
        bearing: -15,
        antialias: true
      });

      map.setMaxBounds(CA_BOUNDS);
      map.setMinZoom(5);
      map.setMaxZoom(20);
      // ‚úÖ no +/- zoom control
    }

    function closeDropdown(){
      $("dropdown").classList.remove("open");
      $("dropdown").innerHTML = "";
    }

    function openSearchCard(feature){
      $("scTitle").textContent = feature?.name || "Result";
      $("scSub").textContent = feature?.full || "";
      $("searchCard").classList.add("open");
    }

    function closeSearchCard(){
      $("searchCard").classList.remove("open");
      selectedSearch = null;
      if (searchMarker) { searchMarker.remove(); searchMarker = null; }
    }

    function openEgg(){ $("egg").classList.add("open"); }
    function closeEgg(){ $("egg").classList.remove("open"); }

    // ‚úÖ Geocoding helper: show clear guidance if blocked (401/403)
    function showGeocodeBlocked(status){
      alert(
        `Geocoding blocked (${status}). Fix in MapTiler:\n\n` +
        `Key ‚Üí Allowed HTTP Origins must be:\n` +
        `oscarxvera.github.io\n\n` +
        `No https:// and no /CheeseMap.github.io/`
      );
    }

    // ‚úÖ Apple-style search with suggestions that zoom exactly to an address (within CA)
    async function maptilerSearch(query){
      const q = (query || "").trim();
      if (q.length < 2) { closeDropdown(); return; }

      const dd = $("dropdown");
      dd.innerHTML = "";
      dd.classList.add("open");

      const head = document.createElement("div");
      head.className = "dd-head";
      head.innerHTML = `
        <div class="muted">Searching‚Ä¶</div>
        <button class="btn ghost" id="ddCloseBtn" style="padding:7px 10px;">Close</button>
      `;
      dd.appendChild(head);
      setTimeout(() => {
        const b = $("ddCloseBtn");
        if (b) b.onclick = () => closeDropdown();
      }, 0);

      // bias towards CA so suggestions are relevant, but still supports any valid US address strings
      const caCenterLng = -119.4179;
      const caCenterLat = 36.7783;

      const url =
        `https://api.maptiler.com/geocoding/${encodeURIComponent(q)}.json` +
        `?key=${MAPTILER_KEY}` +
        `&limit=10` +
        `&country=us` +
        `&autocomplete=true` +
        `&fuzzyMatch=true` +
        `&language=en` +
        `&proximity=${caCenterLng},${caCenterLat}` +
        `&types=address,poi,place,locality,neighborhood,street`;

      let res, data;
      try{
        res = await fetch(url, { headers: { "Accept": "application/json" }});

        if (!res.ok){
          head.querySelector(".muted").textContent = "Blocked";
          if (res.status === 401 || res.status === 403) showGeocodeBlocked(res.status);

          const row = document.createElement("div");
          row.className = "dd-item";
          row.innerHTML = `
            <div style="width:100%">
              <div class="dd-title">Search is blocked</div>
              <div class="dd-sub">
                Status: ${res.status}. Open MapTiler ‚Üí Key ‚Üí Allowed HTTP Origins ‚Üí set to <b>oscarxvera.github.io</b>.
              </div>
            </div>
          `;
          dd.appendChild(row);
          return;
        }

        data = await res.json();
      } catch (e){
        head.querySelector(".muted").textContent = "Error";
        const row = document.createElement("div");
        row.className = "dd-item";
        row.innerHTML = `
          <div style="width:100%">
            <div class="dd-title">Network error</div>
            <div class="dd-sub">Couldn‚Äôt reach MapTiler. Check internet + key restrictions.</div>
          </div>
        `;
        dd.appendChild(row);
        return;
      }

      const feats = Array.isArray(data?.features) ? data.features : [];
      head.querySelector(".muted").textContent = "Results";

      if (!feats.length){
        const none = document.createElement("div");
        none.className = "dd-item";
        none.innerHTML = `
          <div style="width:100%">
            <div class="dd-title">No matches</div>
            <div class="dd-sub">Try including city + ZIP (example: ‚Äú123 Main St, Fresno CA 93722‚Äù).</div>
          </div>
        `;
        dd.appendChild(none);
        return;
      }

      for (const f of feats){
        const coords = f.center || f.geometry?.coordinates;
        if (!coords || typeof coords[0] !== "number" || typeof coords[1] !== "number") continue;

        const lng = coords[0];
        const lat = coords[1];

        const placeName =
          f.place_name ||
          f.text ||
          f.properties?.name ||
          "Result";

        const nameTop = (f.text || placeName).split(",")[0] || placeName;

        const placeType = (f.place_type && f.place_type[0]) ? f.place_type[0] : "";
        const isAddress = placeType === "address" || placeType === "street";
        const inCA = isInCA(lng, lat);

        const icon = isAddress ? "üè†"
                   : (placeType === "poi") ? "üìç"
                   : (placeType === "place" || placeType === "locality") ? "üèôÔ∏è"
                   : "üìç";

        const row = document.createElement("div");
        row.className = "dd-item";
        row.innerHTML = `
          <div class="dd-ico">${icon}</div>
          <div style="min-width:0; width:100%;">
            <div class="dd-title">
              ${escapeHtml(nameTop)}
              ${inCA ? "" : `<span style="color:var(--danger); font-weight:900; margin-left:8px; font-size:12px;">Outside CA</span>`}
            </div>
            <div class="dd-sub">${escapeHtml(placeName)}</div>
          </div>
        `;

        row.onclick = () => {
          closeDropdown();

          selectedSearch = { name: nameTop, full: placeName, lng, lat, placeType };

          $("search").value = placeName;
          $("clearSearch").classList.add("show");

          if (!inCA){
            alert("That result is outside California. This map is locked to CA.");
            openSearchCard(selectedSearch);
            return;
          }

          setSearchMarker(lng, lat);
          const zoom = isAddress ? 18.2 : 15.6;
          map.flyTo({ center:[lng, lat], zoom, speed: 1.2, curve: 1.42 });

          openSearchCard(selectedSearch);
        };

        dd.appendChild(row);
      }
    }

    function performSearch(){
      const q = ($("search").value || "").trim();
      if (q === "IDEN"){
        closeDropdown();
        closeSearchCard();
        openEgg();
        return;
      }
      maptilerSearch(q);
    }

    function locateMe(){
      if (!navigator.geolocation){
        alert("Geolocation not available in this browser.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          if (!isInCA(longitude, latitude)){
            alert("Your location appears outside California. The map is locked to CA.");
            return;
          }
          map.flyTo({ center:[longitude, latitude], zoom: 14.5, speed: 1.2, curve: 1.42 });
        },
        () => alert("Couldn‚Äôt get your location. Check browser permissions."),
        { enableHighAccuracy:true, timeout: 10000 }
      );
    }

    function setToolbarCollapsed(collapsed){
      const topbar = $("topbar");
      topbar.classList.toggle("collapsed", collapsed);
      $("toggleIcon").textContent = collapsed ? "‚åÑ" : "‚åÉ";
      $("toggleText").textContent = collapsed ? "Show" : "Hide";
      $("togglePill").style.top = collapsed ? "14px" : "92px";
      if (collapsed) closeDropdown();
    }

    function wireUI(){
      $("styleSel").addEventListener("change", () => {
        const v = $("styleSel").value;
        map.setStyle(STYLES[v] || STYLES.streets);
      });

      $("btnLocate").onclick = () => locateMe();

      $("btnHelp").onclick = () => {
        alert(
          "How to use:\n\n" +
          "‚Ä¢ Type an address ‚Üí Search (or Enter)\n" +
          "‚Ä¢ Click a suggestion to zoom exactly (within CA)\n" +
          "‚Ä¢ Use the style menu for Dark/Satellite/Hybrid\n\n" +
          "Secret: type IDEN then Search"
        );
      };

      $("search").addEventListener("input", debounce((e) => {
        const v = e.target.value;
        $("clearSearch").classList.toggle("show", !!v);
        if (v.trim() === "IDEN") { closeDropdown(); return; }
        maptilerSearch(v);
      }, 250));

      $("search").addEventListener("keydown", (e) => {
        if (e.key === "Enter"){
          e.preventDefault();
          performSearch();
        }
      });

      $("btnSearch").onclick = () => performSearch();

      $("clearSearch").onclick = () => {
        $("search").value = "";
        $("clearSearch").classList.remove("show");
        closeDropdown();
        closeSearchCard();
      };

      document.addEventListener("click", (ev) => {
        const dd = $("dropdown");
        const s  = $("search");
        const btn = $("btnSearch");
        if (!dd.contains(ev.target) && ev.target !== s && ev.target !== btn) closeDropdown();
      });

      $("btnClearResult").onclick = () => closeSearchCard();

      $("btnEggClose").onclick = () => closeEgg();
      $("egg").addEventListener("click", (e) => { if (e.target && e.target.id === "egg") closeEgg(); });

      let collapsed = false;
      $("togglePill").onclick = () => {
        collapsed = !collapsed;
        setToolbarCollapsed(collapsed);
      };
      setToolbarCollapsed(false);

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeDropdown();
          closeSearchCard();
          if ($("egg").classList.contains("open")) closeEgg();
        }
      });
    }

    initMap();
    wireUI();
  </script>
</body>
</html>
